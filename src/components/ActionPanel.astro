---
interface Props {
	date: Date;
	slug: string;
	title: string;
	description?: string;
	url?: string;
}

const { date, slug, title, description = '', url } = Astro.props;
const formattedDate = date.toLocaleDateString('fr-FR', {
	year: 'numeric',
	month: '2-digit',
	day: '2-digit',
});
const permalink = url ?? new URL(`/${slug}`, Astro.site).href;
const encodedUrl = encodeURIComponent(permalink);
const encodedTitle = encodeURIComponent(title);

const shareLinks = [
	{
		href: `https://bsky.app/intent/compose?text=${encodedTitle}+${encodedUrl}`,
		label: 'Partager sur Bluesky',
		popup: true,
	},
	// {
	// 	href: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,
	// 	label: 'Partager sur LinkedIn',
	// 	popup: true,
	// },
	// {
	// 	href: `mailto:?subject=${encodedTitle}&body=${encodeURIComponent(description)}%0A${encodedUrl}`,
	// 	label: 'Partager par email',
	// 	popup: false,
	// },
];
---

<div class="flex flex-wrap items-center gap-4 py-4 text-sm text-zinc-500">
	<time datetime={date.toISOString()}>{formattedDate}</time>

	<span class="text-zinc-300" aria-hidden="true">|</span>

	<share-button class="contents" data-title={title} data-url={permalink}>
		<!-- Native Web Share API (hidden by default, shown by JS if supported) -->
		<button
			type="button"
			class="hidden items-center gap-1 hover:text-zinc-900 js-share-native"
		>
			<svg class="size-4" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
			Partager
		</button>

		<!-- Social links fallback -->
		<div class="js-share-fallback flex items-center gap-1" role="group" aria-label="Partager">
			<span class="mr-1" aria-hidden="true">Partager</span>

			{shareLinks.map(({ href, label, popup }) => (
				<a
					href={href}
					target={popup ? '_blank' : undefined}
					rel={popup ? 'noopener noreferrer' : undefined}
					aria-label={label}
					class="share-link inline-flex items-center justify-center size-7 rounded-full hover:bg-zinc-200 hover:text-zinc-900 transition-colors"
					data-popup={popup ? 'true' : undefined}
				>
					{label.includes('Bluesky') && (
						<svg class="size-4" aria-hidden="true" viewBox="0 0 24 24" fill="currentColor"><path d="M12 10.8c-1.087-2.114-4.046-6.053-6.798-7.995C2.566.944 1.561 1.266.902 1.565.139 1.908 0 3.08 0 3.768c0 .69.378 5.65.624 6.479.785 2.627 3.601 3.493 6.191 3.16-4.462.753-5.597 3.254-3.143 5.752 4.468 4.297 6.648-1.372 7.328-3.483.68 2.111 2.86 7.78 7.328 3.483 2.454-2.498 1.319-4.999-3.143-5.752 2.59.333 5.406-.533 6.191-3.16.246-.828.624-5.789.624-6.478 0-.69-.139-1.861-.902-2.206-.659-.298-1.664-.62-4.3 1.24C14.046 4.747 11.087 8.686 12 10.8z"/></svg>
					)}
					{label.includes('LinkedIn') && (
						<svg class="size-4" aria-hidden="true" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
					)}
					{label.includes('email') && (
						<svg class="size-4" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
					)}
				</a>
			))}

			<!-- Copy link button (JS-enhanced) -->
			<button
				type="button"
				aria-label="Copier le lien"
				class="js-copy-link inline-flex items-center justify-center size-7 rounded-full hover:bg-zinc-200 hover:text-zinc-900 transition-colors"
				data-url={permalink}
			>
				<svg class="size-4 js-copy-icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
				<svg class="size-4 js-check-icon hidden" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
			</button>
		</div>
	</share-button>

	<span class="text-zinc-300" aria-hidden="true">|</span>

	<a href={`/${slug}`} class="hover:text-zinc-900">Permalien</a>
</div>

<script>
	class ShareButton extends HTMLElement {
		connectedCallback() {
			this.setupCopyLink();
			this.setupPopupLinks();

			if (!navigator.share) return;
			this.setupNativeShare();
		}

		private setupNativeShare() {
			const native = this.querySelector('.js-share-native') as HTMLElement;
			const fallback = this.querySelector('.js-share-fallback') as HTMLElement;

			native?.classList.remove('hidden');
			native?.classList.add('flex');
			fallback?.classList.add('hidden');

			native?.addEventListener('click', () => {
				navigator.share({
					title: this.dataset.title,
					url: this.dataset.url,
				}).catch(() => {});
			});
		}

		private setupPopupLinks() {
			this.querySelectorAll<HTMLAnchorElement>('a.share-link[data-popup]').forEach((link) => {
				link.addEventListener('click', (e) => {
					e.preventDefault();
					window.open(link.href, '_blank', 'width=600,height=500,noopener,noreferrer');
				});
			});
		}

		private setupCopyLink() {
			const btn = this.querySelector('.js-copy-link') as HTMLButtonElement;
			if (!btn) return;

			btn.addEventListener('click', async () => {
				const url = btn.dataset.url;
				if (!url) return;

				try {
					await navigator.clipboard.writeText(url);
				} catch {
					// Fallback for insecure contexts
					const textarea = document.createElement('textarea');
					textarea.value = url;
					textarea.style.position = 'fixed';
					textarea.style.opacity = '0';
					document.body.appendChild(textarea);
					textarea.select();
					document.execCommand('copy');
					document.body.removeChild(textarea);
				}

				const copyIcon = btn.querySelector('.js-copy-icon') as HTMLElement;
				const checkIcon = btn.querySelector('.js-check-icon') as HTMLElement;
				copyIcon?.classList.add('hidden');
				checkIcon?.classList.remove('hidden');
				setTimeout(() => {
					copyIcon?.classList.remove('hidden');
					checkIcon?.classList.add('hidden');
				}, 2000);
			});
		}
	}
	customElements.define('share-button', ShareButton);
</script>
