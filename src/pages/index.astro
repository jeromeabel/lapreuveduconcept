---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import ComicCard from '../components/ComicCard.astro';
import ScrollHelper from '../components/ScrollHelper.astro';

const comics = await getCollection('comics');
const sortedComics = comics.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<Layout type="website" earlyVoteIds={sortedComics.map(c => c.id)}>
	<section class="flex flex-col">
		{sortedComics.map((comic, index) => {
			const currentId = `${comic.id}`;
			const nextComic = sortedComics[index + 1];
			const nextId = nextComic ? `${nextComic.id}` : null;

			return (
				<>
					<div
						id={currentId}
						class:list={[
							'scroll-mt-6 md:scroll-mt-12 transition-opacity duration-1000 ease-out',
							index === 0 ? 'opacity-100' : 'opacity-10',
						]}
						data-reveal={index > 0 ? '' : undefined}
					>
						<ComicCard comic={comic} eager={index === 0} />
					</div>
					{nextId && (
						<ScrollHelper href={`#${nextId}`} />
					)}
				</>
			);
		})}
	</section>
</Layout>

<script>
	const reveals = document.querySelectorAll<HTMLElement>('[data-reveal]');

	const observer = new IntersectionObserver(
		(entries) => {
			for (const entry of entries) {
				if (entry.isIntersecting) {
					entry.target.classList.remove('opacity-10');
					entry.target.classList.add('opacity-100');
					observer.unobserve(entry.target);
				}
			}
		},
		{ threshold: 0.45 },
	);

	for (const el of reveals) {
		observer.observe(el);
	}
</script>
